<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Learning Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&family=Comic+Neue:wght@400;700&display=swap');

        body {
            font-family: 'Comic Neue', 'Assistant', 'Arial', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .eng-text { font-family: 'Comic Neue', 'Arial', sans-serif; letter-spacing: 0.02em; }

        /* Night Mode */
        body.night-mode { background-color: #1a202c !important; color: #f7fafc !important; }
        .night-mode .bg-white, .night-mode .bg-blue-50, .night-mode .bg-purple-50 {
            background-color: #2d3748 !important; color: #ffffff !important;
        }
        .night-mode h1, .night-mode h2, .night-mode h3, .night-mode p, .night-mode span, .night-mode .text-black, .night-mode .text-gray-800 {
            color: #ffffff !important;
        }
        .night-mode textarea { background-color: #2d3748 !important; color: white !important; border-color: #4a5568 !important; }

        /* Animations */
        .perspective-1000 { perspective: 1000px; }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .card-flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
            border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .card-back { transform: rotateY(180deg); }

        .grid-cell {
            aspect-ratio: 1/1; border-radius: 50%; background: #cbd5e0;
            border: 4px solid #4a5568; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .night-mode .grid-cell { background: #4a5568; border-color: #718096; }

        .slot-animation { 
            animation: fall 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
        }
        @keyframes fall { 
            0% { transform: translateY(-300px); opacity: 0; } 
            100% { transform: translateY(0); opacity: 1; } 
        }

        .night-toggle-btn {
            position: fixed; top: 1rem; left: 1.25rem; z-index: 100;
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
            font-size: 1.75rem; background: none; border: none; cursor: pointer; outline: none;
        }

        .confetti {
            position: fixed; width: 10px; height: 10px; z-index: 1000;
            pointer-events: none; animation: confetti-fall 3s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 200;
        }

        /* Clean speaker button - no background */
        .btn-speak-clean {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
            line-height: 1;
        }
        .btn-speak-clean:hover { transform: scale(1.2); }
        .btn-speak-clean:active { transform: scale(0.9); }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 min-h-screen">

    <button id="toggleNight" class="night-toggle-btn">â˜€ï¸</button>
    <div id="app" class="container mx-auto px-4 py-8 max-w-2xl mt-8"></div>

    <script>
        // State Management
        let state = {
            screen: 'input', inputText: '', words: [], nightMode: false,
            testResults: null,
            memoryGame: { mode: 'single', cards: [], flipped: [], pairs: 0, moves: 0, p: 1, s: [0, 0] },
            connect4: { board: Array(6).fill(null).map(() => Array(7).fill(null)), turn: 1, mode: 'ai', q: null, isAnimating: false, canDrop: false, lastMove: null },
            winner: null
        };

        // Text-to-Speech
        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US'; u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }

        // Helpers
        function shuffle(a) { return [...a].sort(() => Math.random() - 0.5); }

        function fireConfetti() {
            const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
            for (let i = 0; i < 100; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.top = '-10px';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                c.style.width = (Math.random() * 8 + 5) + 'px';
                c.style.height = c.style.width;
                c.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }
        }

        // Router/Renderer
        function render() {
            document.body.classList.toggle('night-mode', state.nightMode);
            document.getElementById('toggleNight').innerHTML = state.nightMode ? 'ğŸŒ™' : 'â˜€ï¸';
            const app = document.getElementById('app');
            
            if (state.winner) { renderWinScreen(app); return; }

            switch(state.screen) {
                case 'input': renderInput(app); break;
                case 'flashcards': renderFlashcards(app); break;
                case 'test': renderTest(app); break;
                case 'menu': renderMenu(app); break;
                case 'memory_mode': renderMemoryMode(app); break;
                case 'memory': renderMemory(app); break;
                case 'connect4_mode': renderC4Mode(app); break;
                case 'connect4': renderConnect4(app); break;
            }
        }

        // 1. Input Screen
        function renderInput(app) {
            app.innerHTML = `
                <div class="text-center space-y-6">
                    <h1 class="text-4xl font-bold text-blue-600 eng-text">Word Adventure</h1>
                    <p class="text-lg">×”×›× ×™×¡×• ××™×œ×™× (×× ×’×œ×™×ª - ×¢×‘×¨×™×ª):</p>
                    <textarea id="wordInput" class="w-full h-48 p-4 rounded-2xl border-2 border-blue-200 outline-none text-right text-black" placeholder="apple - ×ª×¤×•×—">${state.inputText}</textarea>
                    <button onclick="processInput()" class="bg-blue-600 text-white px-8 py-4 rounded-full text-xl font-bold w-full shadow-lg transform hover:scale-105 transition">×‘×•××• × ×¦× ×œ×“×¨×š! ğŸš€</button>
                </div>
            `;
            document.getElementById('wordInput').oninput = (e) => state.inputText = e.target.value;
        }

        function processInput() {
            const lines = state.inputText.split('\n').filter(l => l.includes('-'));
            state.words = lines.map(l => {
                const [eng, heb] = l.split('-').map(s => s.trim());
                return { eng, heb, known: false };
            });
            if (state.words.length < 2) return alert('× × ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª 2 ××™×œ×™×');
            state.screen = 'flashcards'; render();
        }

        // 2. Learning Screen (Flashcards)
        function renderFlashcards(app) {
            const unknown = state.words.filter(w => !w.known);
            if (unknown.length === 0) { state.screen = 'test'; render(); return; }
            const cur = unknown[0];
            app.innerHTML = `
                <div class="text-center space-y-6">
                    <h2 class="text-xl font-bold">××›×™×¨×™× ××ª ×”××™×œ×™× (${state.words.filter(w => w.known).length}/${state.words.length})</h2>
                    <div onclick="this.classList.toggle('card-flipped')" class="relative w-64 h-80 mx-auto perspective-1000 cursor-pointer">
                        <div class="card-inner">
                            <div class="card-front bg-white border-4 border-blue-200 text-blue-600 flex-col gap-4">
                                <span class="text-4xl eng-text font-bold text-black">${cur.eng}</span>
                                <button onclick="event.stopPropagation(); speak('${cur.eng}')" class="btn-speak-clean text-4xl">ğŸ”Š</button>
                            </div>
                            <div class="card-back bg-blue-500 text-white border-4 border-blue-600">
                                <span class="text-4xl font-bold">${cur.heb}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 max-w-sm mx-auto">
                        <button onclick="state.words.push(state.words.shift()); render()" class="bg-orange-400 text-white p-4 rounded-xl font-bold flex-1 shadow-md">×¢×•×“ ×§×¦×ª ×ª×¨×’×•×œ</button>
                        <button onclick="state.words.find(w=>w.eng==='${cur.eng}').known=true; render()" class="bg-green-500 text-white p-4 rounded-xl font-bold flex-1 shadow-md">×§×œ×™ ×§×œ×•×ª!</button>
                    </div>
                </div>
            `;
        }

        // 3. Challenge Screen (The "Test")
        function renderTest(app) {
            if (!state.testResults) {
                state.testResults = { questions: shuffle(state.words).map(w => {
                    const isE = Math.random() > 0.5;
                    const correct = isE ? w.heb : w.eng;
                    const opts = shuffle([correct, ...shuffle(state.words.filter(x=>x!==w).map(x=>isE?x.heb:x.eng)).slice(0,3)]);
                    return { word: isE ? w.eng : w.heb, isE, correct, opts, ans: null };
                }), idx: 0 };
            }
            const q = state.testResults.questions[state.testResults.idx];
            if (!q) {
                const score = Math.round((state.testResults.questions.filter(q=>q.ans===q.correct).length/state.words.length)*100);
                app.innerHTML = `
                    <div class="text-center space-y-6 bg-white p-8 rounded-2xl shadow-xl">
                        <h2 class="text-2xl font-bold text-black">${score >= 70 ? '×›×œ ×”×›×‘×•×“! ××ª× ××œ×•×¤×™×! âœ¨' : '×™×•×¤×™ ×©×œ × ×™×¡×™×•×Ÿ! ×‘×•××• × ×—×–×•×¨ ×¢×œ ×–×” ×©×•×‘?'}</h2>
                        <p class="text-xl text-gray-600">×”×¦×œ×—×ª× ×‘-${score}% ××”××™×œ×™×</p>
                        ${score >= 70 ? `<button onclick="state.screen='menu'; state.testResults=null; render()" class="bg-green-600 text-white p-4 rounded-full font-bold w-full shadow-lg">×™××œ×œ×” ×œ××©×—×§×™×! ğŸ®</button>` : 
                        `<button onclick="state.words.forEach(w=>w.known=false); state.testResults=null; state.screen='flashcards'; render()" class="bg-blue-600 text-white p-4 rounded-full font-bold w-full shadow-lg">×—×–×¨×” ×œ×ª×¨×’×•×œ ××”× ×”</button>`}
                    </div>
                `;
                return;
            }
            app.innerHTML = `
                <div class="text-center space-y-4">
                    <h2 class="font-bold text-blue-600">××ª×’×¨ ×”××™×œ×™× (${state.testResults.idx+1}/${state.words.length})</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-blue-50">
                        <div class="flex items-center justify-center gap-4 mb-6">
                            <div class="text-3xl font-bold text-black ${q.isE ? 'eng-text' : ''}">${q.word}</div>
                            ${q.isE ? `<button onclick="speak('${q.word}')" class="btn-speak-clean text-3xl">ğŸ”Š</button>` : ''}
                        </div>
                        <div class="grid gap-3">
                            ${q.opts.map(o => `
                                <div class="flex items-center gap-2">
                                    <button onclick="state.testResults.questions[state.testResults.idx].ans='${o}'; state.testResults.idx++; render()" class="flex-1 p-4 border-2 rounded-xl font-bold text-black hover:bg-blue-50 transition ${!q.isE ? 'eng-text text-xl' : 'text-lg'}">${o}</button>
                                    ${!q.isE ? `<button onclick="speak('${o}')" class="btn-speak-clean text-3xl px-2">ğŸ”Š</button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // 4. Games Menu
        function renderMenu(app) {
            app.innerHTML = `
                <div class="text-center space-y-8">
                    <h2 class="text-3xl font-bold text-blue-600 eng-text uppercase tracking-widest pt-4">Games</h2>
                    <div class="grid gap-4 max-w-sm mx-auto">
                        <button onclick="state.screen='memory_mode'; render()" class="p-8 bg-purple-500 text-white rounded-2xl text-2xl font-bold shadow-lg transform hover:scale-105 transition">×–×™×›×¨×•×Ÿ ğŸ§ </button>
                        <button onclick="state.screen='connect4_mode'; render()" class="p-8 bg-blue-500 text-white rounded-2xl text-2xl font-bold shadow-lg transform hover:scale-105 transition">4 ×‘×©×•×¨×” ğŸ”´</button>
                    </div>
                    <button onclick="state.screen='input'; state.testResults=null; render()" class="mt-8 p-4 px-8 bg-gray-200 text-gray-800 rounded-full font-bold">ğŸ”„ ×”×–× ×ª ××™×œ×™× ×—×“×©×•×ª</button>
                </div>
            `;
        }

        // Memory Game Logic
        function renderMemoryMode(app) {
            app.innerHTML = `
                <div class="text-center space-y-6 pt-4">
                    <h2 class="text-2xl font-bold text-purple-600">××©×—×§ ×–×™×›×¨×•×Ÿ</h2>
                    <div class="space-y-3 max-w-sm mx-auto">
                        <button onclick="startMemory('single')" class="p-6 bg-white border-2 border-purple-100 rounded-xl text-xl font-bold w-full text-black">×©×—×§×Ÿ ×™×—×™×“</button>
                        <button onclick="startMemory('multi')" class="p-6 bg-white border-2 border-purple-100 rounded-xl text-xl font-bold w-full text-black">×©× ×™ ×©×—×§× ×™×</button>
                        <button onclick="state.screen='menu'; render()" class="text-gray-500 underline block w-full">×—×–×¨×” ×œ×ª×¤×¨×™×˜</button>
                    </div>
                </div>
            `;
        }

        function startMemory(m) {
            state.screen = 'memory';
            const cards = [];
            state.words.slice(0, 8).forEach(w => {
                cards.push({ t: w.eng, m: w.heb, type: 'eng' }, { t: w.heb, m: w.eng, type: 'heb' });
            });
            state.memoryGame = { mode: m, cards: shuffle(cards).map((c, i) => ({ ...c, id: i, f: false, ok: false })), flipped: [], pairs: 0, moves: 0, p: 1, s: [0, 0] };
            state.winner = null; render();
        }

        function renderMemory(app) {
            const g = state.memoryGame;
            app.innerHTML = `
                <div class="text-center space-y-4">
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border mb-2">
                        <button onclick="state.screen='menu'; render()" class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm">×™×¦×™××”</button>
                        <div class="font-bold text-sm text-black">
                            ${g.mode==='single' ? `××”×œ×›×™×: ${g.moves}` : `×ª×•×¨ ×©×—×§×Ÿ ${g.p} | ${g.s[0]}-${g.s[1]}`}
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        ${g.cards.map(c => `
                            <div onclick="flipM(${c.id})" class="relative aspect-[3/4] perspective-1000 cursor-pointer ${c.f || c.ok ? 'card-flipped' : ''}">
                                <div class="card-inner">
                                    <div class="card-front bg-purple-500 border-2 border-white"></div>
                                    <div class="card-back bg-white border-2 border-purple-100 p-1 ${c.ok?'border-green-500':''}">
                                        <div class="flex flex-col items-center justify-center h-full gap-1">
                                            <span class="font-bold text-black text-center ${c.type==='eng'?'eng-text':''} text-xs sm:text-base">${c.t}</span>
                                            ${c.type==='eng' ? `<button onclick="event.stopPropagation(); speak('${c.t}')" class="btn-speak-clean text-lg">ğŸ”Š</button>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            if (g.pairs === g.cards.length / 2) {
                if (g.mode === 'single') state.winner = { msg: "× ×™×¦×—×ª!", score: `×¡×™×™××ª ×‘-${g.moves} ××”×œ×›×™×!` };
                else state.winner = { msg: g.s[0]>g.s[1] ? "×©×—×§×Ÿ 1 × ×™×¦×—!" : g.s[1]>g.s[0] ? "×©×—×§×Ÿ 2 × ×™×¦×—!" : "×ª×™×§×•!", score: `×ª×•×¦××”: ${g.s[0]} ××•×œ ${g.s[1]}` };
                fireConfetti(); setTimeout(render, 500);
            }
        }

        function flipM(id) {
            const g = state.memoryGame;
            const c = g.cards.find(x=>x.id===id);
            if (c.f || c.ok || g.flipped.length === 2) return;
            c.f = true; g.flipped.push(c); render();
            if (g.flipped.length === 2) {
                g.moves++;
                const [c1, c2] = g.flipped;
                if (c1.t === c2.m) {
                    c1.ok = c2.ok = true; g.pairs++;
                    if (g.mode==='multi') g.s[g.p-1]++;
                    g.flipped = []; render();
                } else {
                    setTimeout(() => { c1.f = c2.f = false; g.flipped = []; if (g.mode==='multi') g.p = g.p===1?2:1; render(); }, 1000);
                }
            }
        }

        // Connect 4 Logic
        function renderC4Mode(app) {
            app.innerHTML = `
                <div class="text-center space-y-6 pt-4">
                    <h2 class="text-2xl font-bold text-blue-600">4 ×‘×©×•×¨×”</h2>
                    <div class="space-y-3 max-w-sm mx-auto">
                        <button onclick="startC4('ai')" class="p-6 bg-white border-2 border-blue-100 rounded-xl text-xl font-bold w-full text-black">× ×’×“ ×”××—×©×‘</button>
                        <button onclick="startC4('multi')" class="p-6 bg-white border-2 border-blue-100 rounded-xl text-xl font-bold w-full text-black">×©× ×™ ×©×—×§× ×™×</button>
                        <button onclick="state.screen='menu'; render()" class="text-gray-500 underline block w-full">×—×–×¨×” ×œ×ª×¤×¨×™×˜</button>
                    </div>
                </div>
            `;
        }

        function startC4(m) {
            state.screen = 'connect4';
            state.connect4 = { board: Array(6).fill(null).map(() => Array(7).fill(null)), turn: 1, mode: m, isAnimating: false, canDrop: false, q: genQ(), lastMove: null };
            state.winner = null; render();
        }

        function genQ() {
            const w = state.words[Math.floor(Math.random()*state.words.length)];
            const isE = Math.random()>0.5;
            const correct = isE ? w.heb : w.eng;
            return { w: isE?w.eng:w.heb, isE, correct, opts: shuffle([correct, ...shuffle(state.words.filter(x=>x!==w).map(x=>isE?x.heb:x.eng)).slice(0,3)]) };
        }

        function renderConnect4(app) {
            const c = state.connect4;
            const isAI = c.mode==='ai' && c.turn===2;
            app.innerHTML = `
                <div class="text-center space-y-4">
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border mb-2">
                        <button onclick="state.screen='menu'; render()" class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm">×™×¦×™××”</button>
                        <div class="font-bold text-sm text-black">×ª×•×¨: ${c.turn===1 ? '<span class="text-red-500">××“×•×</span>' : '<span class="text-yellow-500">×¦×”×•×‘</span>'}</div>
                    </div>
                    ${!c.canDrop && !c.isAnimating && !isAI ? `
                        <div class="modal-overlay p-4">
                            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                                <h3 class="font-bold mb-4 text-black">× ×¦×—×• ××ª ××ª×’×¨ ×”××™×œ×”:</h3>
                                <div class="bg-blue-50 p-4 rounded-xl mb-4 flex items-center justify-center gap-2">
                                    <span class="text-2xl font-bold text-black ${c.q.isE ? 'eng-text' : ''}">${c.q.w}</span>
                                    ${c.q.isE ? `<button onclick="speak('${c.q.w}')" class="btn-speak-clean text-2xl">ğŸ”Š</button>` : ''}
                                </div>
                                <div class="grid gap-2">
                                    ${c.q.opts.map(o => `
                                        <div class="flex items-center gap-2">
                                            <button onclick="ansC4('${o}')" class="flex-1 p-3 border rounded-xl font-bold text-black hover:bg-blue-50 text-sm ${!c.q.isE ? 'eng-text' : ''}">${o}</button>
                                            ${!c.q.isE ? `<button onclick="speak('${o}')" class="btn-speak-clean text-2xl px-1">ğŸ”Š</button>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `:''}
                    <div class="flex justify-around mb-2">
                        ${[0,1,2,3,4,5,6].map(i => `<button onclick="dropC4(${i})" class="text-3xl ${!c.canDrop || c.isAnimating || c.board[0][i] ? 'opacity-20 pointer-events-none' : ''}">ğŸ‘‡</button>`).join('')}
                    </div>
                    <div class="bg-blue-700 p-2 rounded-xl inline-block border-4 border-blue-800">
                        <div class="grid grid-cols-7 gap-1">
                            ${c.board.map((row, rIdx) => row.map((cell, cIdx) => `
                                <div class="grid-cell w-10 h-10 sm:w-14 sm:h-14 flex items-center justify-center">
                                    ${cell ? `<div class="w-5/6 h-5/6 rounded-full shadow-md ${cell===1?'bg-red-500':'bg-yellow-400'} ${state.connect4.lastMove && state.connect4.lastMove.r === rIdx && state.connect4.lastMove.c === cIdx ? 'slot-animation' : ''}"></div>` : ''}
                                </div>
                            `).join('')).join('')}
                        </div>
                    </div>
                </div>
            `;
            if (isAI && !c.isAnimating) {
                setTimeout(() => { 
                    const valid = [0,1,2,3,4,5,6].filter(i=>!c.board[0][i]);
                    if (valid.length) { c.canDrop = true; dropC4(valid[Math.floor(Math.random()*valid.length)]); }
                }, 1000);
            }
        }

        function ansC4(o) {
            if (o === state.connect4.q.correct) { state.connect4.canDrop = true; render(); }
            else { alert('××•×¤×¡, × ×¡×• ×©×•×‘ ×‘×ª×•×¨ ×”×‘×!'); nextC4(); }
        }

        function dropC4(col) {
            const c = state.connect4;
            let row = -1;
            for (let r=5; r>=0; r--) { if (!c.board[r][col]) { row = r; break; } }
            if (row === -1) return;
            c.isAnimating = true; 
            c.lastMove = { r: row, c: col };
            c.board[row][col] = c.turn; 
            render();
            setTimeout(() => {
                if (checkWin(c.board)) {
                    state.winner = { msg: c.mode==='ai' && c.turn===1 ? "× ×™×¦×—×ª ××ª ×”××—×©×‘!" : c.mode==='ai' && c.turn===2 ? "×”××—×©×‘ × ×™×¦×— ×”×¤×¢×..." : `×©×—×§×Ÿ ${c.turn} × ×™×¦×—!`, score: "" };
                    fireConfetti(); render();
                } else nextC4();
            }, 500);
        }

        function nextC4() {
            state.connect4.turn = state.connect4.turn===1?2:1;
            state.connect4.canDrop = false; state.connect4.isAnimating = false;
            state.connect4.q = genQ(); 
            state.connect4.lastMove = null;
            render();
        }

        function checkWin(b) {
            for (let r=0; r<6; r++) for (let c=0; c<4; c++) if (b[r][c] && b[r][c]==b[r][c+1] && b[r][c]==b[r][c+2] && b[r][c]==b[r][c+3]) return true;
            for (let r=0; r<3; r++) for (let c=0; c<7; c++) if (b[r][c] && b[r][c]==b[r+1][c] && b[r][c]==b[r+2][c] && b[r][c]==b[r+3][c]) return true;
            for (let r=0; r<3; r++) for (let c=0; c<4; c++) {
                if (b[r][c] && b[r][c]==b[r+1][c+1] && b[r][c]==b[r+2][c+2] && b[r][c]==b[r+3][c+3]) return true;
                if (b[r][c+3] && b[r][c+3]==b[r+1][c+2] && b[r][c+3]==b[r+2][c+1] && b[r][c+3]==b[r+3][c]) return true;
            }
            return false;
        }

        // Win Screen
        function renderWinScreen(app) {
            app.innerHTML = `
                <div class="text-center space-y-8 bg-white p-12 rounded-3xl shadow-2xl border-4 border-yellow-400">
                    <div class="text-6xl mb-4 animate-bounce">ğŸ†</div>
                    <h2 class="text-4xl font-bold text-black">${state.winner.msg}</h2>
                    <p class="text-2xl text-gray-600">${state.winner.score}</p>
                    <div class="flex flex-col gap-3">
                        <button onclick="retryGame()" class="bg-green-600 text-white p-5 rounded-2xl text-xl font-bold shadow-lg transform hover:scale-105 transition">×©×—×§×• ×©×•×‘ ğŸ®</button>
                        <button onclick="state.winner=null; state.screen='menu'; render()" class="bg-gray-200 text-gray-800 p-4 rounded-2xl font-bold">×—×–×¨×” ×œ××©×—×§×™×</button>
                    </div>
                </div>
            `;
        }

        function retryGame() {
            const m = state.screen;
            state.winner = null;
            if (m === 'memory') startMemory(state.memoryGame.mode);
            else if (m === 'connect4') startC4(state.connect4.mode);
        }

        // Night Mode Toggle Listener
        document.getElementById('toggleNight').onclick = () => { state.nightMode = !state.nightMode; render(); };
        
        // Initial Render
        render();
    </script>
</body>
</html>

