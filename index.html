<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Magic - Full Games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { touch-action: manipulation; margin: 0; padding: 0; height: 100%; }
        html, #root { height: 100%; }
        .perspective { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Firebase Setup
        const firebaseConfig = { apiKey: "EMPTY", authDomain: "YOUR_PROJECT.firebaseapp.com", projectId: "YOUR_PROJECT_ID", storageBucket: "YOUR_PROJECT.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const getFinalConfig = () => { try { if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config); } catch(e) {} return firebaseConfig; };
        if (!firebase.apps.length) firebase.initializeApp(getFinalConfig());
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'english-magic-v2';

        const speak = (text) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.85;
            window.speechSynthesis.speak(utterance);
        };

        const Icons = {
            Volume: ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>,
            Moon: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Sun: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line></svg>,
            Trash: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        };

        // --- Game: Spelling (Dictation) ---
        const SpellingGame = ({ words, onBack, isDark }) => {
            const [idx, setIdx] = useState(0);
            const [input, setInput] = useState("");
            const [status, setStatus] = useState("playing"); // playing, correct, finished
            const current = words[idx];

            useEffect(() => { if (current) speak(current.eng); }, [idx]);

            const check = (e) => {
                e.preventDefault();
                if (input.toLowerCase().trim() === current.eng.toLowerCase().trim()) {
                    setStatus("correct");
                    setTimeout(() => {
                        if (idx + 1 < words.length) {
                            setIdx(idx + 1);
                            setInput("");
                            setStatus("playing");
                        } else setStatus("finished");
                    }, 1000);
                } else {
                    setStatus("wrong");
                    setTimeout(() => setStatus("playing"), 1000);
                }
            };

            if (status === "finished") return (
                <div className="text-center p-8 space-y-6">
                    <h2 className="text-4xl font-black"> 转转! </h2>
                    <button onClick={onBack} className="bg-sky-500 text-white px-8 py-3 rounded-xl font-bold">专</button>
                </div>
            );

            return (
                <div className="flex flex-col items-center space-y-8 py-10 w-full max-w-sm mx-auto">
                    <div className="text-center">
                        <span className="opacity-50 text-sm font-bold"> {idx + 1} 转 {words.length}</span>
                        <h2 className="text-2xl font-black">转 转</h2>
                    </div>
                    <button onClick={() => speak(current.eng)} className="w-24 h-24 bg-sky-500 text-white rounded-full flex items-center justify-center shadow-xl active:scale-90 transition-transform">
                        <Icons.Volume size={40} />
                    </button>
                    <form onSubmit={check} className="w-full space-y-4">
                        <input 
                            type="text" 
                            value={input} 
                            onChange={(e) => setInput(e.target.value)}
                            autoFocus
                            dir="ltr"
                            className={`w-full p-4 rounded-2xl border-4 text-center text-2xl font-black outline-none transition-all ${
                                status === 'correct' ? 'border-green-500 bg-green-50' : 
                                status === 'wrong' ? 'border-red-500 bg-red-50 animate-shake' : 
                                (isDark ? 'bg-slate-900 border-slate-700' : 'bg-white border-sky-100')
                            }`}
                            placeholder="Type here..."
                        />
                        <button type="submit" className="w-full bg-sky-500 text-white py-4 rounded-2xl font-black text-xl">拽 转</button>
                    </form>
                </div>
            );
        };

        // --- Game: Memory ---
        const MemoryGame = ({ words, onBack, isDark }) => {
            const [cards, setCards] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [matched, setMatched] = useState([]);
            const [moves, setMoves] = useState(0);

            useEffect(() => {
                const gameSize = Math.min(words.length, 6);
                const selection = [...words].sort(() => 0.5 - Math.random()).slice(0, gameSize);
                const pairSet = [];
                selection.forEach(w => {
                    pairSet.push({ id: `eng-${w.id}`, text: w.eng, matchId: w.id, type: 'eng' });
                    pairSet.push({ id: `heb-${w.id}`, text: w.heb, matchId: w.id, type: 'heb' });
                });
                setCards(pairSet.sort(() => 0.5 - Math.random()));
            }, [words]);

            const handleFlip = (card) => {
                if (flipped.length === 2 || flipped.includes(card.id) || matched.includes(card.matchId)) return;
                const newFlipped = [...flipped, card.id];
                setFlipped(newFlipped);
                if (newFlipped.length === 2) {
                    setMoves(m => m + 1);
                    const c1 = cards.find(c => c.id === newFlipped[0]);
                    const c2 = cards.find(c => c.id === newFlipped[1]);
                    if (c1.matchId === c2.matchId) {
                        setMatched([...matched, c1.matchId]);
                        setFlipped([]);
                    } else {
                        setTimeout(() => setFlipped([]), 1000);
                    }
                }
            };

            if (matched.length === cards.length / 2 && cards.length > 0) return (
                <div className="text-center p-8 space-y-4">
                    <h2 className="text-4xl font-black text-yellow-500">爪转! </h2>
                    <p className="font-bold">住转 -{moves} .</p>
                    <button onClick={onBack} className="bg-sky-500 text-white px-8 py-3 rounded-xl font-bold">专</button>
                </div>
            );

            return (
                <div className="w-full max-w-md mx-auto py-6">
                    <div className="flex justify-between items-center mb-6 px-2">
                        <span className="font-black">: {moves}</span>
                        <button onClick={onBack} className="text-sm opacity-50 underline">爪</button>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                        {cards.map(card => {
                            const isOpen = flipped.includes(card.id) || matched.includes(card.matchId);
                            return (
                                <div key={card.id} onClick={() => handleFlip(card)} className="aspect-square perspective cursor-pointer">
                                    <div className={`relative w-full h-full preserve-3d transition-transform duration-500 ${isOpen ? 'rotate-y-180' : ''}`}>
                                        <div className={`absolute inset-0 backface-hidden rounded-xl border-2 flex items-center justify-center text-2xl shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-sky-100 text-sky-500'}`}>?</div>
                                        <div className={`absolute inset-0 backface-hidden rotate-y-180 rounded-xl border-2 flex items-center justify-center p-2 text-center text-xs font-black leading-tight ${isDark ? 'bg-sky-900 border-white' : 'bg-sky-500 border-white text-white shadow-inner'}`}>
                                            {card.text}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- Flashcards Loop ---
        const Flashcards = ({ words, onFinish, isDark }) => {
            const [queue, setQueue] = useState([...words]);
            const [idx, setIdx] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const current = queue[idx];

            const handleNext = (wellKnown) => {
                if (!wellKnown) setQueue([...queue, current]);
                if (idx + 1 < queue.length) { setIdx(idx + 1); setIsFlipped(false); }
                else onFinish();
            };

            return (
                <div className="flex flex-col items-center space-y-6 flex-grow py-4">
                    <div className="text-center">
                        <span className="text-xs opacity-50 font-bold"> {idx + 1} 转 {queue.length}</span>
                        <h2 className="text-xl font-black italic">砖 1:  转专</h2>
                    </div>
                    <div className="w-64 aspect-[3/4] perspective" onClick={() => setIsFlipped(!isFlipped)}>
                        <div className={`relative w-full h-full preserve-3d transition-transform duration-500 rounded-3xl shadow-xl ${isFlipped ? 'rotate-y-180' : ''}`}>
                            <div className={`absolute inset-0 backface-hidden rounded-3xl border-4 flex flex-col items-center justify-center ${isDark ? 'bg-slate-900 border-sky-500' : 'bg-white border-sky-400'}`}>
                                <h3 className="text-3xl font-black">{current.eng}</h3>
                                <button onClick={(e) => { e.stopPropagation(); speak(current.eng); }} className="mt-6 p-3 bg-sky-100 text-sky-600 rounded-full"><Icons.Volume size={20}/></button>
                            </div>
                            <div className={`absolute inset-0 backface-hidden rotate-y-180 rounded-3xl border-4 flex items-center justify-center text-white ${isDark ? 'bg-sky-900' : 'bg-sky-600'}`}>
                                <h3 className="text-3xl font-black">{current.heb}</h3>
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4 w-full max-w-xs">
                        <button onClick={() => handleNext(false)} className="bg-red-100 text-red-600 p-4 rounded-2xl font-black flex flex-col items-center"><span></span><span className="text-xs">注  注</span></button>
                        <button onClick={() => handleNext(true)} className="bg-green-100 text-green-600 p-4 rounded-2xl font-black flex flex-col items-center"><span></span><span className="text-xs">注</span></button>
                    </div>
                </div>
            );
        };

        // --- Knowledge Test (Gate) ---
        const KnowledgeGate = ({ words, onPass, onFail, isDark }) => {
            const [idx, setIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [options, setOptions] = useState([]);
            const [selected, setSelected] = useState(null);
            const current = words[idx];

            useEffect(() => {
                if (!current) return;
                const opts = [...words.filter(w => w.id !== current.id).sort(() => 0.5 - Math.random()).slice(0, 3), current].sort(() => 0.5 - Math.random());
                setOptions(opts);
                setSelected(null);
            }, [idx]);

            const handleAnswer = (opt) => {
                if (selected) return;
                setSelected(opt.id);
                const isCorrect = opt.id === current.id;
                if (isCorrect) { setScore(s => s + 1); speak(current.eng); }
                setTimeout(() => {
                    if (idx + 1 < words.length) setIdx(idx + 1);
                    else {
                        const final = ((score + (isCorrect?1:0)) / words.length) * 100;
                        if (final >= 70) onPass(); else onFail(final);
                    }
                }, 800);
            };

            return (
                <div className="flex flex-col space-y-6 w-full max-w-sm mx-auto py-10">
                    <h2 className="text-xl font-black text-center"> 注专 (70% 爪)</h2>
                    <div className="p-10 rounded-3xl text-center border-4 border-sky-500 font-black text-3xl">{current.eng}</div>
                    <div className="space-y-2">
                        {options.map(opt => (
                            <button key={opt.id} onClick={() => handleAnswer(opt)} className={`w-full p-4 rounded-xl font-bold border-2 transition-all ${selected === opt.id ? (opt.id === current.id ? 'bg-green-500 border-green-600 text-white' : 'bg-red-500 border-red-600 text-white animate-shake') : (isDark ? 'bg-slate-900 border-slate-700' : 'bg-white border-sky-50')}`}>{opt.heb}</button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [view, setView] = useState('setup');
            const [wordList, setWordList] = useState([]);
            const [isDark, setIsDark] = useState(false);
            const [user, setUser] = useState(null);
            const [savedLists, setSavedLists] = useState([]);

            useEffect(() => { document.body.style.backgroundColor = isDark ? "#020617" : "#f0f9ff"; }, [isDark]);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (u) setUser(u);
                    else (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) ? await auth.signInWithCustomToken(__initial_auth_token) : await auth.signInAnonymously();
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsub = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('wordLists').onSnapshot(s => setSavedLists(s.docs.map(d => ({...d.data(), id: d.id}))));
                return () => unsub();
            }, [user]);

            const start = () => {
                const val = document.getElementById('words-input').value;
                const parsed = val.split('\n').map(l => {
                    const p = l.split(/[,\t\-:|]+/).map(i => i.trim());
                    return p.length >= 2 ? { eng: p[0], heb: p[1], id: Math.random().toString(36).substr(2,9) } : null;
                }).filter(Boolean);
                if (parsed.length >= 4) { setWordList(parsed); setView('learning'); }
            };

            return (
                <div className={`min-h-screen flex flex-col p-4 transition-colors duration-300 ${isDark ? 'bg-slate-950 text-white' : 'bg-sky-50 text-slate-900'}`}>
                    <header className="flex justify-between items-center h-12 mb-6 max-w-md mx-auto w-full">
                        <button onClick={() => setIsDark(!isDark)} className={`w-10 h-10 rounded-xl flex items-center justify-center border ${isDark ? 'bg-slate-800 border-slate-700 text-yellow-400' : 'bg-white border-sky-100 text-sky-500'}`}>{isDark ? <Icons.Sun/> : <Icons.Moon/>}</button>
                        <h1 className="text-2xl font-black text-sky-500 italic">English Magic</h1>
                        <div className="w-10"></div>
                    </header>

                    <main className="flex-grow max-w-md mx-auto w-full">
                        {view === 'setup' && (
                            <div className="space-y-6">
                                <div className={`p-6 rounded-[2.5rem] shadow-xl border-2 flex flex-col ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-white'}`}>
                                    <textarea id="words-input" className={`w-full h-48 p-4 rounded-2xl border-2 outline-none text-left font-black transition-all ${isDark ? 'bg-slate-950 border-slate-800 focus:border-yellow-500' : 'bg-sky-50 border-sky-100 focus:border-sky-400'}`} dir="ltr" placeholder="Apple - 转驻&#10;Book - 住驻专"></textarea>
                                    <button onClick={start} className="w-full bg-sky-500 text-white py-4 rounded-2xl font-black text-xl shadow-lg mt-4 active:scale-95 transition-transform">转 </button>
                                </div>
                                {savedLists.map(l => (
                                    <div key={l.id} onClick={() => { setWordList(l.words); setView('learning'); }} className={`p-4 rounded-2xl shadow-sm flex justify-between items-center cursor-pointer border ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-white'}`}>
                                        <span className="font-black">{l.name} ({l.words.length})</span>
                                        <button onClick={(e) => { e.stopPropagation(); db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('wordLists').doc(l.id).delete(); }} className="text-red-400 p-2"><Icons.Trash/></button>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'learning' && <Flashcards words={wordList} onFinish={() => setView('gate')} isDark={isDark} />}
                        {view === 'gate' && <KnowledgeGate words={wordList} onPass={() => setView('games')} onFail={(s) => setView('gate-failed')} isDark={isDark} />}
                        {view === 'gate-failed' && <div className="text-center py-20 space-y-6"><div className="text-6xl"></div><h2 className="text-2xl font-black"> 注专转 转 </h2><button onClick={() => setView('learning')} className="w-full bg-sky-500 text-white py-4 rounded-2xl font-black">专 </button></div>}

                        {view === 'games' && (
                            <div className="flex flex-col space-y-4 py-6">
                                <div className="bg-green-500 text-white p-6 rounded-3xl text-center shadow-lg"><h2 className="text-3xl font-black">爪转! コ</h2><p className="font-bold opacity-80">注专转 转 砖  爪.</p></div>
                                <button onClick={() => setView('memory')} className="w-full bg-indigo-500 text-white py-6 rounded-3xl font-black text-2xl shadow-xl active:scale-95">砖拽 专 </button>
                                <button onClick={() => setView('spelling')} className="w-full bg-orange-500 text-white py-6 rounded-3xl font-black text-2xl shadow-xl active:scale-95">砖拽 转 锔</button>
                                <button onClick={() => setView('setup')} className="text-sky-500 font-bold p-4 text-center underline">专 转驻专</button>
                            </div>
                        )}

                        {view === 'memory' && <MemoryGame words={wordList} onBack={() => setView('games')} isDark={isDark} />}
                        {view === 'spelling' && <SpellingGame words={wordList} onBack={() => setView('games')} isDark={isDark} />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

