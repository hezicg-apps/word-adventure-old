<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Learning Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&family=Comic+Neue:wght@400;700&display=swap');

        body {
            font-family: 'Comic Neue', 'Assistant', 'Arial', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .eng-text { font-family: 'Comic Neue', 'Arial', sans-serif; letter-spacing: 0.02em; }

        /* Night Mode */
        body.night-mode { background-color: #1a202c !important; color: #f7fafc !important; }
        .night-mode .bg-white, .night-mode .bg-blue-50 {
            background-color: #2d3748 !important; color: #ffffff !important;
        }
        .night-mode .text-black, .night-mode .text-gray-800 { color: #ffffff !important; }

        /* Perspective for Flip Effect */
        .perspective-1000 { perspective: 1000px; }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .card-flipped .card-inner { transform: rotateY(180deg); }
        
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 1rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 10px;
        }
        .card-back { transform: rotateY(180deg); overflow: hidden; }

        /* Connect 4 Grid Layout */
        .c4-board {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            background-color: #1e40af;
            padding: 10px;
            border-radius: 12px;
            width: fit-content;
            margin: 0 auto;
        }

        .grid-cell {
            width: 42px; height: 42px;
            background-color: #cbd5e0;
            border-radius: 50%;
            border: 2px solid #1e3a8a;
            position: relative; overflow: hidden;
        }
        @media (min-width: 640px) {
            .grid-cell { width: 58px; height: 58px; }
        }

        .falling-token-anim {
            position: absolute; left: 10%; top: -100%;
            width: 80%; height: 80%; border-radius: 50%;
            transition: top 0.2s linear;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100;
        }

        .arrows-row {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 6px; width: fit-content; margin: 0 auto 10px auto; padding: 0 10px;
        }
        
        .arrow-btn {
            width: 42px; display: flex; justify-content: center; font-size: 1.5rem;
            transition: opacity 0.3s ease, transform 0.2s;
        }
        @media (min-width: 640px) {
            .arrow-btn { width: 58px; font-size: 2rem; }
        }

        /* Dynamic Card Text Container */
        .card-text-container {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .card-text-dynamic {
            display: inline-block;
            white-space: nowrap;
            font-weight: bold;
            color: #000;
        }

        /* Fade-in animation */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 min-h-screen flex flex-col items-center">

    <button id="toggleNight" class="fixed top-4 left-4 z-[110] text-2xl">â˜€ï¸</button>
    
    <div id="app" class="container mx-auto px-4 py-8 max-w-2xl flex flex-col items-center w-full"></div>

    <script>
        let state = {
            screen: 'input', inputText: '', words: [], nightMode: false,
            memoryGame: { cards: [], flipped: [], pairs: 0 },
            connect4: { board: Array(6).fill(null).map(() => Array(7).fill(null)), turn: 1, q: null, isAnimating: false, canDrop: false, showQuestionPrompt: true },
            winner: null
        };

        function speak(text) {
            if (!text) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US'; u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }

        function shuffle(a) { return [...a].sort(() => Math.random() - 0.5); }

        function fireConfetti() {
            const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
            for (let i = 0; i < 80; i++) {
                const c = document.createElement('div');
                c.style.position = 'fixed'; c.style.width = '8px'; c.style.height = '8px';
                c.style.left = '50vw'; c.style.top = '50vh';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                c.style.zIndex = '1000';
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 300 + 150;
                c.animate([
                    { transform: 'translate(0,0) scale(1)', opacity: 1 },
                    { transform: `translate(${Math.cos(angle)*velocity}px, ${Math.sin(angle)*velocity}px) rotate(360deg)`, opacity: 0 }
                ], { duration: 1500, easing: 'ease-out', fill: 'forwards' });
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 1500);
            }
        }

        // Calculates font size based on word length and card width
        function getDynamicFontSize(text) {
            const len = text.length;
            if (len <= 4) return '1.5rem';
            if (len <= 7) return '1.2rem';
            if (len <= 10) return '1rem';
            if (len <= 13) return '0.85rem';
            return '0.75rem';
        }

        function render() {
            document.body.classList.toggle('night-mode', state.nightMode);
            const app = document.getElementById('app');
            app.innerHTML = '';
            if (state.winner) { renderWinScreen(app); return; }
            switch(state.screen) {
                case 'input': renderInput(app); break;
                case 'flashcards': renderFlashcards(app); break;
                case 'menu': renderMenu(app); break;
                case 'memory': renderMemory(app); break;
                case 'connect4': renderConnect4(app); break;
            }
        }

        function renderInput(app) {
            app.innerHTML = `
                <div class="text-center space-y-6 w-full mt-10">
                    <h1 class="text-4xl font-bold text-blue-600 eng-text">Word Adventure</h1>
                    <p class="text-lg">×”×›× ×™×¡×• ××™×œ×™× (×× ×’×œ×™×ª - ×¢×‘×¨×™×ª):</p>
                    <textarea id="wordInput" class="w-full h-48 p-4 rounded-2xl border-2 border-blue-200 outline-none text-right text-black text-lg shadow-inner" placeholder="apple - ×ª×¤×•×—">${state.inputText}</textarea>
                    <button onclick="processInput()" class="bg-blue-600 text-white px-8 py-4 rounded-full text-xl font-bold w-full shadow-lg transition active:scale-95">×‘×•××• × ×¦× ×œ×“×¨×š! ğŸš€</button>
                </div>
            `;
            document.getElementById('wordInput').oninput = (e) => state.inputText = e.target.value;
        }

        function processInput() {
            const lines = state.inputText.split('\n').filter(l => l.includes('-'));
            state.words = lines.map(l => {
                const [eng, heb] = l.split('-').map(s => s.trim());
                return { eng, heb, known: false };
            });
            if (state.words.length < 2) return;
            state.screen = 'flashcards'; render();
        }

        function renderFlashcards(app) {
            const unknown = state.words.filter(w => !w.known);
            if (unknown.length === 0) { state.screen = 'menu'; render(); return; }
            const cur = unknown[0];
            app.innerHTML = `
                <div class="text-center space-y-6 w-full max-w-sm mt-4">
                    <h2 class="text-xl font-bold">×”×›×¨×ª ×”××™×œ×™× (${state.words.filter(w => w.known).length}/${state.words.length})</h2>
                    
                    <div onclick="this.classList.toggle('card-flipped')" class="relative w-full h-80 perspective-1000 cursor-pointer mx-auto group">
                        <div class="card-inner">
                            <div class="card-front bg-white border-4 border-blue-200">
                                <span class="text-5xl font-bold text-blue-600 eng-text mb-4">${cur.eng}</span>
                                <button onclick="event.stopPropagation(); speak('${cur.eng}')" class="text-4xl p-2 bg-blue-50 rounded-full hover:scale-110 transition mb-6">ğŸ”Š</button>
                                <p class="text-gray-400 text-sm animate-pulse">×œ×—×¦×• ×›×“×™ ×œ×¡×•×‘×‘ ğŸ”„</p>
                            </div>
                            <div class="card-back bg-blue-500 border-4 border-blue-600 text-white">
                                <span class="text-5xl font-bold">${cur.heb}</span>
                                <p class="mt-8 text-blue-100 text-sm">×œ×—×¦×• ×›×“×™ ×œ×—×–×•×¨ ğŸ”„</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 w-full">
                        <button onclick="state.words.push(state.words.shift()); render()" class="bg-orange-400 text-white p-4 rounded-xl font-bold flex-1 text-lg shadow-md">×¢×•×“ ×ª×¨×’×•×œ</button>
                        <button onclick="state.words.find(w=>w.eng==='${cur.eng}').known=true; render()" class="bg-green-500 text-white p-4 rounded-xl font-bold flex-1 text-lg shadow-md">×§×œ×™ ×§×œ×•×ª!</button>
                    </div>
                </div>
            `;
        }

        function renderMenu(app) {
            app.innerHTML = `
                <div class="text-center space-y-6 w-full max-w-md mt-10">
                    <h2 class="text-3xl font-bold text-blue-600 eng-text uppercase">×‘×—×¨ ××©×—×§</h2>
                    <button onclick="startMemory()" class="p-8 bg-purple-500 text-white rounded-2xl text-2xl font-bold shadow-lg w-full transform hover:scale-105 transition">××©×—×§ ×–×™×›×¨×•×Ÿ ğŸ§ </button>
                    <button onclick="startC4()" class="p-8 bg-blue-500 text-white rounded-2xl text-2xl font-bold shadow-lg w-full transform hover:scale-105 transition">4 ×‘×©×•×¨×” ğŸ”´ğŸŸ¡</button>
                    <button onclick="state.screen='input'; render()" class="text-gray-500 underline block mt-4">×”×—×œ×¤×ª ××™×œ×™×</button>
                </div>
            `;
        }

        // --- Memory ---
        function startMemory() {
            state.screen = 'memory';
            const cards = [];
            // Use up to 8 pairs
            state.words.slice(0, 8).forEach(w => {
                cards.push({ t: w.eng, m: w.heb, type: 'eng' }, { t: w.heb, m: w.eng, type: 'heb' });
            });
            state.memoryGame = { cards: shuffle(cards).map((c, i) => ({ ...c, id: i, f: false, ok: false })), flipped: [], pairs: 0 };
            render();
        }

        function renderMemory(app) {
            const g = state.memoryGame;
            app.innerHTML = `
                <div class="w-full flex flex-col items-center">
                    <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl border-2 border-purple-200 w-full max-w-sm shadow-sm">
                        <button onclick="state.screen='menu'; render()" class="text-red-500 font-bold hover:scale-105 transition">×™×¦×™××”</button>
                        <div class="font-bold text-purple-700 text-xl">×–×•×’×•×ª: ${g.pairs} / ${g.cards.length/2}</div>
                    </div>
                    <div class="grid grid-cols-4 gap-2 sm:gap-3 max-w-sm w-full">
                        ${g.cards.map(c => {
                            const fontSize = getDynamicFontSize(c.t);
                            return `
                            <div onclick="flipM(${c.id})" class="relative aspect-[1/1.2] perspective-1000 cursor-pointer ${c.f || c.ok ? 'card-flipped' : ''}">
                                <div class="card-inner w-full h-full">
                                    <div class="card-front bg-purple-600 shadow-lg text-white text-2xl">?</div>
                                    <div class="card-back bg-white border-4 p-2 shadow-lg ${c.ok?'border-green-400':'border-purple-200'}">
                                        <div class="card-text-container">
                                            <span class="card-text-dynamic" style="font-size: ${fontSize};">
                                                ${c.t}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            if (g.pairs > 0 && g.pairs === g.cards.length / 2) {
                state.winner = { msg: "×›×œ ×”×›×‘×•×“! × ×™×¦×—×ª ×‘×–×™×›×¨×•×Ÿ ğŸ§ " };
                fireConfetti(); setTimeout(render, 500);
            }
        }

        function flipM(id) {
            const g = state.memoryGame; const c = g.cards.find(x=>x.id===id);
            if (c.f || c.ok || g.flipped.length === 2) return;
            c.f = true; g.flipped.push(c); render();
            if (g.flipped.length === 2) {
                const [c1, c2] = g.flipped;
                if (c1.t === c2.m) {
                    c1.ok = c2.ok = true; g.pairs++; g.flipped = [];
                    const engWord = c1.type === 'eng' ? c1.t : c2.t;
                    setTimeout(() => speak(engWord), 300);
                    render();
                } else {
                    setTimeout(() => { c1.f = c2.f = false; g.flipped = []; render(); }, 1200);
                }
            }
        }

        // --- Connect 4 ---
        function startC4() {
            state.screen = 'connect4';
            state.connect4 = { board: Array(6).fill(null).map(() => Array(7).fill(null)), turn: 1, isAnimating: false, canDrop: false, showQuestionPrompt: true, q: genQ() };
            state.winner = null; render();
        }

        function genQ() {
            const w = state.words[Math.floor(Math.random()*state.words.length)];
            return { eng: w.eng, correct: w.heb, opts: shuffle([w.heb, ...shuffle(state.words.filter(x=>x!==w).map(x=>x.heb)).slice(0,3)]) };
        }

        function renderConnect4(app) {
            const c = state.connect4;
            app.innerHTML = `
                <div class="flex flex-col items-center w-full">
                    <div class="w-full flex justify-between items-center mb-4 bg-white p-3 rounded-lg shadow-sm border">
                        <button onclick="state.screen='menu'; render()" class="text-red-500 font-bold">×™×¦×™××”</button>
                        <div class="text-lg font-bold">
                            ×ª×•×¨: ${c.turn===1 ? '<span class="text-red-600">××“×•× ğŸ”´</span>' : '<span class="text-yellow-600">×¦×”×•×‘ ğŸŸ¡</span>'}
                        </div>
                    </div>

                    <div class="h-24 w-full flex flex-col items-center justify-center mb-2">
                        ${c.showQuestionPrompt ? `
                            <div class="bg-white p-4 rounded-2xl shadow-md border-2 border-blue-100 flex flex-col items-center w-full max-w-sm animate-fade-in">
                                <button onclick="triggerQuestion()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition w-full">×”×¦×’ ×©××œ×” ×œ××¡×™××•×Ÿ</button>
                            </div>
                        ` : `
                            <div class="bg-green-50 p-3 rounded-xl border-2 border-green-200 text-green-700 font-bold text-center w-full max-w-sm animate-fade-in">
                                ${c.canDrop ? '××¢×•×œ×”! ×‘×—×¨ ×¢××•×“×” ğŸ‘‡' : '×¢× ×” ×¢×œ ×”×©××œ×” ×›×“×™ ×œ×©×—×§...'}
                            </div>
                        `}
                    </div>

                    ${!c.canDrop && !c.showQuestionPrompt && !c.isAnimating ? `
                        <div class="modal-overlay">
                            <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full border-4 border-blue-500 mx-4 text-center">
                                <p class="text-gray-500 mb-2">××™×š ××•××¨×™× ×‘×¢×‘×¨×™×ª?</p>
                                <div class="flex items-center justify-center gap-3 mb-6">
                                    <h2 class="text-4xl font-bold text-black eng-text">${c.q.eng}</h2>
                                    <button onclick="speak('${c.q.eng}')" class="text-3xl p-1 hover:scale-110 transition">ğŸ”Š</button>
                                </div>
                                <div class="grid gap-3">
                                    ${c.q.opts.map(o => `
                                        <button onclick="ansC4('${o}')" class="p-4 border-2 border-gray-100 rounded-2xl font-bold text-black text-xl hover:bg-blue-50 active:scale-95 transition">${o}</button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="arrows-row">
                        ${[0,1,2,3,4,5,6].map(i => `
                            <button onclick="dropC4(${i})" 
                                class="arrow-btn ${!c.canDrop || c.isAnimating || c.board[0][i] ? 'opacity-20 grayscale pointer-events-none' : 'hover:scale-110 active:scale-90 transition'}"
                                ${!c.canDrop ? 'disabled' : ''}>
                                ğŸ‘‡
                            </button>
                        `).join('')}
                    </div>

                    <div class="c4-board shadow-2xl border-4 border-blue-900">
                        ${c.board.map((row, rIdx) => row.map((cell, cIdx) => `
                            <div class="grid-cell">
                                ${cell ? `<div class="w-full h-full rounded-full ${cell===1?'bg-red-500':'bg-yellow-400'} shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)]"></div>` : ''}
                                <div id="anim-${rIdx}-${cIdx}" class="falling-token-anim ${c.turn===1?'bg-red-500':'bg-yellow-400'}"></div>
                            </div>
                        `).join('')).join('')}
                    </div>
                </div>
            `;
        }

        function triggerQuestion() {
            state.connect4.showQuestionPrompt = false; render();
            setTimeout(() => speak(state.connect4.q.eng), 300);
        }

        function ansC4(o) {
            const c = state.connect4;
            if (o === c.q.correct) {
                c.canDrop = true; render();
            } else {
                c.turn = c.turn===1?2:1; c.showQuestionPrompt = true; c.q = genQ(); render();
            }
        }

        function dropC4(col) {
            const c = state.connect4;
            let rowIdx = -1;
            for (let r=5; r>=0; r--) { if (!c.board[r][col]) { rowIdx = r; break; } }
            if (rowIdx === -1) return;

            c.isAnimating = true; render();
            let currentR = 0;
            const animate = () => {
                const el = document.getElementById(`anim-${currentR}-${col}`);
                if (el) el.style.top = '10%';
                if (currentR < rowIdx) {
                    setTimeout(() => { if (el) el.style.top = '110%'; currentR++; animate(); }, 70);
                } else {
                    setTimeout(() => {
                        c.board[rowIdx][col] = c.turn;
                        if (checkWin(c.board)) {
                            state.winner = { msg: c.turn===1 ? "×”××“×•× × ×™×¦×— ×‘×§×¨×‘! ğŸ”´" : "×”×¦×”×•×‘ × ×™×¦×— ×‘×§×¨×‘! ğŸŸ¡" };
                            fireConfetti(); render();
                        } else {
                            c.turn = c.turn===1?2:1; c.canDrop = false; c.isAnimating = false; c.showQuestionPrompt = true; c.q = genQ(); render();
                        }
                    }, 70);
                }
            };
            animate();
        }

        function checkWin(b) {
            for (let r=0; r<6; r++) for (let c=0; c<4; c++) if (b[r][c] && b[r][c]==b[r][c+1] && b[r][c]==b[r][c+2] && b[r][c]==b[r][c+3]) return true;
            for (let r=0; r<3; r++) for (let c=0; c<7; c++) if (b[r][c] && b[r][c]==b[r+1][c] && b[r][c]==b[r+2][c] && b[r][c]==b[r+3][c]) return true;
            for (let r=0; r<3; r++) for (let c=0; c<4; c++) {
                if (b[r][c] && b[r][c]==b[r+1][c+1] && b[r][c]==b[r+2][c+2] && b[r][c]==b[r+3][c+3]) return true;
                if (b[r][c+3] && b[r][c+3]==b[r+1][c+2] && b[r][c+3]==b[r+2][c+1] && b[r][c+3]==b[r+3][c]) return true;
            }
            return false;
        }

        function renderWinScreen(app) {
            app.innerHTML = `
                <div class="text-center space-y-8 bg-white p-12 rounded-3xl shadow-2xl border-8 border-yellow-400 w-full max-w-md mt-10">
                    <h2 class="text-4xl font-bold text-black">${state.winner.msg} ğŸ‰</h2>
                    <button onclick="state.winner=null; state.screen='menu'; render()" class="bg-blue-600 text-white px-8 py-4 rounded-2xl text-2xl font-bold w-full shadow-lg hover:bg-blue-700 transition">×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>
                </div>
            `;
        }

        document.getElementById('toggleNight').onclick = () => { state.nightMode = !state.nightMode; render(); };
        render();
    </script>
</body>
</html>

