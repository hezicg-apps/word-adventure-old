<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Magic</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for browser compilation -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        .perspective { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const getFinalConfig = () => {
            try {
                if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
            } catch(e) {}
            return firebaseConfig;
        };

        firebase.initializeApp(getFinalConfig());
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "english-magic-v2";

        // --- Icons ---
        const Icons = {
            Volume: ({ size = 20 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            ),
            Trash: () => (
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            ),
            Moon: () => (
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            ),
            Sun: () => (
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            ),
            Save: () => (
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
            )
        };

        const speak = (text) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        };

        // --- Components ---

        const MemoryGame = ({ words, onSpeak, onBack, isDark }) => {
            const [cards, setCards] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [matched, setMatched] = useState([]);
            const [moves, setMoves] = useState(0);
            const [isFinished, setIsFinished] = useState(false);

            const initGame = () => {
                const gameSize = Math.min(words.length, 6);
                const selection = [...words].sort(() => 0.5 - Math.random()).slice(0, gameSize);
                const deck = [];
                selection.forEach(w => {
                    deck.push({ id: `${w.id}-eng`, wordId: w.id, text: w.eng, type: 'eng' });
                    deck.push({ id: `${w.id}-heb`, wordId: w.id, text: w.heb, type: 'heb' });
                });
                setCards(deck.sort(() => 0.5 - Math.random()));
                setFlipped([]);
                setMatched([]);
                setMoves(0);
                setIsFinished(false);
            };

            useEffect(() => { initGame(); }, [words]);

            const handleFlip = (card) => {
                if (flipped.length === 2 || flipped.includes(card.id) || matched.includes(card.wordId)) return;
                const newFlipped = [...flipped, card.id];
                setFlipped(newFlipped);
                if (newFlipped.length === 2) {
                    setMoves(m => m + 1);
                    const c1 = cards.find(c => c.id === newFlipped[0]);
                    const c2 = cards.find(c => c.id === newFlipped[1]);
                    if (c1.wordId === c2.wordId) {
                        setMatched([...matched, c1.wordId]);
                        setFlipped([]);
                        onSpeak(c1.type === 'eng' ? c1.text : c2.text);
                        if (matched.length + 1 === cards.length / 2) setIsFinished(true);
                    } else setTimeout(() => setFlipped([]), 1000);
                }
            };

            if (isFinished) {
                return (
                    <div className="flex flex-col h-full justify-center items-center text-center space-y-4">
                        <h2 className={`text-3xl font-black ${isDark ? 'text-white' : 'text-sky-900'}`}>××œ×•×£ ×”×–×™×›×¨×•×Ÿ! ğŸ†</h2>
                        <p className="text-sky-500 font-bold text-lg">×¡×™×™××ª ×‘-{moves} ××”×œ×›×™×.</p>
                        <button onClick={initGame} className="w-full max-w-xs bg-green-500 text-white py-4 rounded-2xl font-black text-xl shadow-lg">×©×—×§ ×©×•×‘ ğŸ”</button>
                        <button onClick={onBack} className="w-full max-w-xs bg-sky-500 text-white py-4 rounded-2xl font-black text-xl shadow-lg">×—×–×¨×” ğŸ </button>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full">
                    <div className="flex justify-between items-center mb-4 px-2">
                        <button onClick={onBack} className="text-sky-500 font-black">â† ×—×–×•×¨</button>
                        <div className="font-black text-sm opacity-60">×¦×¢×“×™×: {moves}</div>
                    </div>
                    <div className="grid grid-cols-3 gap-2 flex-grow content-center">
                        {cards.map(card => {
                            const isFlipped = flipped.includes(card.id) || matched.includes(card.wordId);
                            return (
                                <div key={card.id} className="aspect-square perspective cursor-pointer" onClick={() => handleFlip(card)}>
                                    <div className={`relative w-full h-full preserve-3d transition-transform duration-500 ${isFlipped ? 'rotate-y-180' : ''}`}>
                                        <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-sky-100'} absolute inset-0 rounded-xl border-2 shadow flex items-center justify-center backface-hidden`}>
                                           <div className="opacity-20 text-sky-400 font-black">?</div>
                                        </div>
                                        <div className={`${isDark ? 'bg-slate-700 border-slate-500' : 'bg-white border-sky-300'} absolute inset-0 border-2 rounded-xl flex items-center justify-center backface-hidden rotate-y-180 shadow-inner overflow-hidden`}>
                                            <span className={`text-[10px] md:text-sm font-black text-center px-1 break-words ${card.type === 'eng' ? 'text-indigo-500' : 'text-pink-500'}`}>
                                                {card.text}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const SpellingGame = ({ words, onSpeak, onBack, isDark }) => {
            const [queue, setQueue] = useState([]);
            const [idx, setIdx] = useState(0);
            const [input, setInput] = useState("");
            const [status, setStatus] = useState("playing");

            useEffect(() => { setQueue([...words].sort(() => Math.random() - 0.5)); }, [words]);
            const current = queue[idx];

            const handleSubmit = (e) => {
                e.preventDefault();
                if (input.toLowerCase().trim() === current.eng.toLowerCase().trim()) {
                    setStatus("correct");
                    onSpeak(current.eng);
                    setTimeout(() => {
                        if (idx + 1 < queue.length) { setIdx(idx + 1); setInput(""); setStatus("playing"); }
                        else setStatus("finished");
                    }, 800);
                } else {
                    setStatus("wrong");
                    setTimeout(() => setStatus("playing"), 800);
                }
            };

            if (status === "finished") {
                return (
                    <div className="flex flex-col h-full justify-center items-center text-center space-y-6">
                        <h2 className={`text-4xl font-black ${isDark ? 'text-white' : 'text-sky-900'}`}>××œ×š ×”×”×›×ª×‘×•×ª! ğŸ‘‘</h2>
                        <button onClick={onBack} className="w-full max-w-xs bg-sky-500 text-white py-4 rounded-2xl font-black text-xl shadow-lg">×—×–×¨×” ×œ×ª×¤×¨×™×˜</button>
                    </div>
                );
            }
            if (!current) return null;

            return (
                <div className="flex flex-col h-full">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={onBack} className="text-sky-500 font-black">×—×–×•×¨</button>
                        <span className="text-xs opacity-50 font-black" dir="ltr">{idx + 1} / {queue.length}</span>
                    </div>
                    <div className="flex-grow flex flex-col items-center justify-center space-y-4">
                        <h3 className={`text-3xl font-black ${isDark ? 'text-sky-200' : 'text-sky-900'}`}>{current.heb}</h3>
                        <button onClick={() => onSpeak(current.eng)} className="p-6 bg-sky-500 text-white rounded-full shadow-lg">
                            <Icons.Volume size={32} />
                        </button>
                        <form onSubmit={handleSubmit} className="w-full max-w-xs pt-4">
                            <input autoFocus className={`w-full p-4 text-center text-2xl font-black rounded-2xl border-4 mb-3 outline-none ${status === 'correct' ? 'border-green-400 bg-green-50' : status === 'wrong' ? 'border-red-400 bg-red-50' : isDark ? 'bg-slate-900 border-slate-700 text-white' : 'bg-sky-50 border-sky-100'}`} placeholder="..." value={input} onChange={(e) => setInput(e.target.value)} dir="ltr" />
                            <button className="w-full bg-indigo-500 text-white py-3 rounded-xl font-black">×‘×“×•×§!</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Main App ---

        const App = () => {
            const [view, setView] = useState('setup');
            const [wordList, setWordList] = useState([]);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [user, setUser] = useState(null);
            const [savedLists, setSavedLists] = useState([]);
            const [listName, setListName] = useState("");

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(u => {
                    if (u) setUser(u);
                    else auth.signInAnonymously();
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsub = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('wordLists')
                    .onSnapshot(snap => setSavedLists(snap.docs.map(d => ({...d.data(), id: d.id}))));
                return () => unsub();
            }, [user]);

            const startLearning = () => {
                const input = document.getElementById('word-input').value;
                const parsed = input.split('\n').map(l => {
                    const parts = l.split(/[,\t\-:|]+/).map(p => p.trim());
                    return parts.length >= 2 ? { eng: parts[0], heb: parts[1], id: Math.random().toString(36).substr(2,9) } : null;
                }).filter(Boolean);
                if (parsed.length) { setWordList(parsed); setView('games'); }
            };

            return (
                <div className={`${isDarkMode ? 'bg-slate-950 text-white' : 'bg-sky-50 text-slate-900'} min-h-screen transition-colors duration-500 p-4`}>
                    <div className="max-w-md mx-auto">
                        <div className="relative flex items-center justify-center mb-6 h-12">
                            <h1 className={`text-3xl font-black tracking-tighter ${isDarkMode ? 'text-sky-400' : 'text-sky-600'}`}>English Magic</h1>
                            <button 
                                onClick={() => setIsDarkMode(!isDarkMode)} 
                                className={`absolute left-0 w-10 h-10 flex items-center justify-center rounded-xl shadow-md transition-all active:scale-95 ${
                                    isDarkMode ? 'bg-slate-800 text-yellow-400 border border-slate-700' : 'bg-white text-indigo-600 border border-sky-50'
                                }`}
                                title={isDarkMode ? "Light Mode" : "Dark Mode"}
                            >
                                {isDarkMode ? <Icons.Sun /> : <Icons.Moon />}
                            </button>
                        </div>

                        {view === 'setup' && (
                            <div className="space-y-4">
                                <div className={`${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-white'} p-6 rounded-3xl shadow-xl border-2`}>
                                    <textarea id="word-input" className={`w-full h-32 p-3 rounded-xl border-2 outline-none text-left font-bold mb-4 ${isDarkMode ? 'bg-slate-950 border-slate-800' : 'bg-sky-50 border-sky-100'}`} dir="ltr" placeholder="Apple - ×ª×¤×•×—..."></textarea>
                                    <button onClick={startLearning} className="w-full bg-sky-500 text-white py-4 rounded-xl font-black text-xl shadow-lg">×‘×•××• × ×ª×—×™×œ!</button>
                                </div>
                                <div className="space-y-2">
                                    {savedLists.map(list => (
                                        <div key={list.id} onClick={() => { setWordList(list.words); setView('games'); }} className={`${isDarkMode ? 'bg-slate-900' : 'bg-white'} p-4 rounded-xl shadow flex justify-between cursor-pointer`}>
                                            <span className="font-black">{list.name} ({list.words.length})</span>
                                            <button onClick={(e) => { e.stopPropagation(); db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('wordLists').doc(list.id).delete(); }} className="text-red-400"><Icons.Trash /></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'games' && (
                            <div className="flex flex-col space-y-4">
                                <button onClick={() => setView('memory-game')} className="bg-indigo-500 p-10 rounded-3xl text-white font-black text-2xl shadow-xl">×–×™×›×¨×•×Ÿ ğŸ§ </button>
                                <button onClick={() => setView('spelling-game')} className="bg-pink-500 p-10 rounded-3xl text-white font-black text-2xl shadow-xl">×”×›×ª×‘×” âœï¸</button>
                                <div className="pt-6 border-t border-slate-300 flex gap-2">
                                    <input className={`flex-1 p-3 rounded-xl border-2 ${isDarkMode ? 'bg-slate-900' : 'bg-white'}`} placeholder="×©× ×œ×©××™×¨×”..." value={listName} onChange={e => setListName(e.target.value)} />
                                    <button onClick={() => {
                                        if(!listName) return;
                                        db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('wordLists').add({ name: listName, words: wordList });
                                        setListName("");
                                    }} className="bg-green-500 text-white p-3 rounded-xl"><Icons.Save /></button>
                                </div>
                                <button onClick={() => setView('setup')} className="text-sky-500 font-bold">×—×–×¨×” ×œ××¡×š ×”×¨××©×™</button>
                            </div>
                        )}

                        {view === 'memory-game' && <MemoryGame words={wordList} onSpeak={speak} onBack={() => setView('games')} isDark={isDarkMode} />}
                        {view === 'spelling-game' && <SpellingGame words={wordList} onSpeak={speak} onBack={() => setView('games')} isDark={isDarkMode} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

